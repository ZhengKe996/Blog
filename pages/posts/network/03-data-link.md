---
title: '数据链路层'
date: 2023-11-02
type: NetWork
---

## 数据链路层概述

- **链路（Link）**是指从一个节点到相邻节点的一段物理线路（有线或无线），而**中间没有任何其他的交换节点**。
- 数据链路（Data Link）是基于链路的。当在一条链路上传送数据时，除需要链路本身，还需要一些必要的通信协议来控制这些数据的传输，**把实现这些协议的硬件和软件加到链路上**，就构成了数据链路。
- 计算机中的**网络适配器**（俗称网卡）和其相应的软件驱动程序就实现了这些协议。一般的**网络适配器都包含了物理层和数据链路层这两层的功能**。
- 帧（Frame）是**数据链路层**对等实体之间在水平方向进行逻辑通信的协议数据单元 **PDU**。

## 数据链路层的三个重要问题

### 封装成帧

- 封装成帧是指数据链路层给上层交付下来的协议数据单元 PDU 添加一个首部和一个尾部，使之成为帧。

  - 帧的首部和尾部中包含有一些**重要的控制信息**。
  - 帧首部和尾部的作用之一就是**帧定界**。
  - `[注]` 并不是每一种数据链路层协议的帧都包含有帧定界标志。
  - 帧间间隔（发送 96 比特所耗费的时间）

- 为了提高数据链路层传输帧的效率，应当使**帧的数据载荷的长度尽可能地大于首部和尾部的长度**。
- 考虑到对缓存空间的需求以及差错控制等诸多因素，每一种数据链路层协议都规定了帧的数据载荷的长度上限，即**最大传送单元**（Maximum Transfer Unit，MTU）。例如，以太网的 MTU 为 1500 个字节。

![封装成帧](/public/images/network/03/1-1-1.png)
![封装成帧](/public/images/network/03/1-1-2.png)

![帧定界](/public/images/network/03/1-1-3.png)

### 透明传输

透明传输是指**数据链路层对上层交付下来的协议数据单元 PDU 没有任何限制**，就好像数据链路层不存在一样。

- 面向字节的物理链路使用**字节填充**的方法实现透明传输。
- 面向比特的物理链路使用**比特填充**的方法实现透明传输。(零比特填充：每 5 个 1 后插入一个 0)

![透明传输](/public/images/network/03/1-1-5.png)

### 差错检测

- 帧在传输的过程中可能出现误码。
- 接收方根据发送方添加在帧尾部中的检错码，可以检测出帧是否出现了误码。

#### 误码的相关概念

- 实际的通信链路都不是理想的，比特在传输过程中可能会产生差错（称为**比特差错**）
  - 比特 1 可能变成比特 0
  - 比特 0 可能变成比特 1
- 在一段时间内，传输错误的比特数量占所传输比特总数的比率称为**误码率**（Bit Error Rate，BER）。
- **提高链路的信噪比**，可以**降低误码率**。但在实际的通信链路上，不可能使误码率下降为零。
- 使用**差错检测技术**来检测数据在传输过程中是否产生了比特差错，是数据链路层所要解决的重要问题之一。

![差错检测](/public/images/network/03/1-1-6.png)

#### 奇偶校验

- 奇校验是在待发送的数据后面**添加 1 个校验位**，使得添加该校验位后的整个数据中**比特 1 的个数为奇数**。
- 偶校验是在待发送的数据后面**添加 1 个校验位**，使得添加该校验位后的整个数据中**比特 1 的个数为偶数**。
- 在所传输的数据中，如果有**奇数个位发生误码**，则所包含比特 1 的数量的奇偶性会发生改变，**可以检测出误码**。
- 在所传输的数据中，如果有**偶数个位发生误码**，则所包含比特 1 的数量的奇偶性不会发生改变，**无法检测出误码（漏检）**。
- 在实际使用时，奇偶校验又可分为垂直奇偶校验、水平奇偶校验以及水平垂直奇偶校验。

#### 循环冗余校验（CRC）

- 数据链路层广泛使用漏检率极低的循环冗余校验（Cyclic Redundancy Check，CRC）检错技术。

  - 收发双方约定好一个生成多项式 G(X)。
  - 发送方基于待发送的数据和**生成多项式 G(X)**，计算出差错检测码（冗余码），将冗余码添加到待发送数据的后面一起传输。
  - 接收方收到数据和冗余码后，通过生成多项式 G(X)来计算收到的数据和冗余码是否产生了误码。

![CRC](/public/images/network/03/1-1-7.png)
![CRC](/public/images/network/03/1-1-8.png)

### 可靠传输

- 不可靠传输服务：收到有误码的帧，直接丢弃，其他什么也不做；未收到发送方发送的帧，也不进行任何处理。
- 可靠传输服务：实现发送方发送什么，接收方最终都能正确收到。
- 一般情况下，**有线链路的误码率比较低**。为了减小开销，**并不要求数据链路层向其上层提供可靠传输服务**。即使出现了误码，可靠传输的问题由其上层处理。
- **无线链路**易受干扰，**误码率比较高**，因此**要求数据链路层必须向其上层提供可靠传输服务**。

#### 传输差错

1. **误码（比特差错）**
2. **分组丢失**：输入队列快满了，主动丢弃收到的分组
3. **分组失序**：分组到达顺序与发送顺序不同
4. **分组重复**：路由器繁忙，分组在输入队列中等待较长时间，导致发送方重发，使得接收方收到了重复分组。

![传输差错](/public/images/network/03/1-2-1.png)

**`[注意📢]`**

- **可靠传输服务并不局限于数据链路层**，其他各层均可选择实现可靠传输。
- 可靠传输的实现比较复杂，开销比较大，是否使用可靠传输取决于应用需求。

![传输差错](/public/images/network/03/1-2-2.png)

#### 停止-等待协议

![传输差错](/public/images/network/03/1-2-3.png)

**`[注意📢]`**

- 使用超时重传机制后，就可以不使用否认机制了，这样可使协议实现起来更加简单。但是，如果点对点链路的误码率较高，**使用否认机制可以使发送方在超时计时器超时前就尽快重传。**
- 为了让接收方能够判断所收到的数据分组是否是重复的，需要给**数据分组编号**。由于**停止-等待协议**的特性，**只需 1 个比特编序号**即可，即序号 0 和序号 1。
- 为了让发送方能够判断所收到的确认分组是否是重复的，需要给**确认分组编号**，所用比特数量与**数据分组所用比特数量一样**。

  - 数据链路层一般不会出现确认分组迟到的情况，**因此在数据链路层实现停止-等待协议可以不用给确认分组编号**。

- 给超时计时器设置的超时重传时间 RTO 应当仔细选择，**一般将 RTO 设置为略大于收发双方的平均往返时间 RTT**。

  - 在数据链路层，点对点的往返时间 RTT 比较固定，RTO 就比较好设定。
  - 在运输层，由于端到端往返时间非常不确定，设置合适的超时重传时间 RTO 有时并不容易。

- 停止-等待协议属于自动请求重传（Automatic Repeat reQuest，**ARQ**）协议。即重传的请求是发送方自动进行的，而不是接收方请求发送方重传某个误码的数据分组。

![传输差错](/public/images/network/03/1-2-4.png)

- 若出现超时重传，对于传送有用的数据信息来说，信道利用率还要降低。
- 在往返时间 RTT 相对较大的情况下，为了提高信道利用率，收发双方不适合采用停止-等待协议，而可以选择使用回退 N 帧（GBN）协议或选择重传（SR）协议。

#### 回退 N 帧协议

**采用流水线传输可以显著提高信道利用率**
![传输差错](/public/images/network/03/1-2-5.png)

<hr />

![传输差错](/public/images/network/03/1-2-6.png)

#### 选择重传协议

![传输差错](/public/images/network/03/1-2-7.png)

为了使发送方仅重传出现差错的数据分组，接收方不再采用**累积确认**，而需要对每一个正确接收的数据分组进行**逐一确认**。

![传输差错](/public/images/network/03/1-2-8.png)

## 点对点协议(PPP)

- 点对点协议（Point-to-Point Protocol，PPP）是目前使用最广泛的点对点数据链路层协议。
- 点对点协议 PPP 是因特网工程任务组（Internet Engineering Task Force，IETF）于 1992 年制定的。经过多次修订，目前 PPP 已成为因特网的正式标准[RFC1661，RFC1662]。

### PPP 的帧格式

![点对点协议](/public/images/network/03/1-3-1.png)

- 面向字节的异步链路使用字节填充来实现透明传输`[RFC1662]`
- 发送方的处理：

  1. 将数据载荷中出现的每一个 0x7E 减去 0x20（相当于异或 0x20），然后在其前面插入转义字符 0x7D。
  2. 若数据载荷中原来就含有 0x7D，则把每一个 0x7D 减去 0x20，然后在其前面插入转义字符 0x7D。
  3. 将数据载荷中出现的每一个 ASCII 码控制字符（即数值小于 0x20 的字符），加上 0x20（相当于异或 0x20，将其转换成非控制字符），然后在其前面插入转义字符 0x7D。
  4. 对帧的数据载荷进行扫描（一般由硬件完成），每出现 5 个连续的比特 1，则在其后填充一个比特 0。(零比特填充法)

- 接收方的处理：

  1. 进行与发送方**相反的变换**，就可以正确地恢复出未经过字节填充的原始数据载荷。
  2. 对帧的数据载荷进行扫描，每出现 5 个连续的比特 1 时，就把其后的一个比特 0 删除。

- 帧检验序列 FCS 字段：
  1. 其值是使用循环冗余校验 CRC 计算出的检错码。
  2. CRC 采用的生成多项式为  `CRC−CCITT=X^16+X^12+X^5+1`

**`[注意📢]`**

使用 PPP 的数据链路层，**向上提供的是不可靠数据传输服务**。
![点对点协议](/public/images/network/03/1-3-2.png)

## 媒体接入控制

共享信道要着重考虑的一个问题就是如何协调多个发送和接收站点对一个共享传输媒体的占用，即媒体接入控制 MAC

![媒体接入控制](/public/images/network/03/1-4-1.png)

- **静态划分信道:**

  - 预先固定分配好信道：这类方法非常不灵活，对于突发性数据传输信道利用率会很低.通常在无线网络的物理层中使用，而不是在数据链路层中使用。

- **受控接入:**

  - 集中控制：有一个主站以循环方式轮询每个站点有无数据发送，只有轮询到的站点才能发送数据，最大的缺点是**单点故障问题**
  - 分散控制：各站点是平等的，并连接成一个环形网络令牌沿环站点传递，接收到令牌的站点才有权发送数据，并在发送完数据后指令传递给下一个站点。

- **随机接入：** 所有站点经过竞争，随机地在信道上发送数据，如果恰巧有两个或更多的站点在同一时刻发送数据，则信号在共享媒体上就要产生碰撞，使得这些站点的发送都失败。因此，这类协议要解决的关键问题是如何尽量避免冲突及在发生冲突后如何尽快恢复通信。

**随着技术的发展，交换技术的成熟和成本的降低，具有更高性能的使用点对点链路和链路层交换机的交换式局域网在有线领域已完全取代了共享式局域网，但由于无线信道的广播天性，无线局域网仍然使用的是共享媒体技术。**

### 静态划分信道

![媒体接入控制](/public/images/network/03/1-4-2.png)

- 复用（Multiplexing）是通信技术中的一个重要概念。复用就是通过一条物理线路同时传输多路用户的信号。
- 当网络中传输媒体的传输容量大于多条单一信道传输的总通信量时，可利用复用技术在一条物理线路上建立多条通信信道来充分利用传输媒体的带宽。

1. 频分复用（FDM）：频分复用的所有用户**同时占用不同**的频带资源**井行通信**。
2. 时分复用（TDM）：时分复用的所有用户在**不同的时间**占用**同样的频带宽度**。
3. 波分复用（WDM）
4. 码分复用（CDM）：
   - CDM 的每一个用户可以**在同样的时间使用同样的频带进行通信**。
   - 由于**各用户使用经过特殊挑选的不同码型**，因此各用户之间**不会造成干扰**。
   - 在 CDMA 中，每一个比特时间再划分为 m 个短的间隔，称为码片 （Chip）。通常 m 是 64or128
   - 使用 CDMA 的每一个站被指派一个唯一的 m bit 码片序列 （Chip Sequence）
     - 一个站如果要发送比特 1，则发送它自己的 m bit 码片序列；
     - 一个站如果要发送比特 0，则发送它自己的 m bit 码片序列的二进制反码
   - 码片序列的挑选原则如下：
     - 分配给每个站的**码片序列必须各不相同**，实际常采用伪随机码序列。
     - 分配给每个站的**码片序列必须相互正交**（规格化内积为 0）

## CSMA/CD 协议

为了解决**各站点争用总线的问题**，共享总线以太网使用了一种专用协议 **CSMA/CD**，它是**载波监听多址接入/碰撞检测**（Carrier Sense Multiple Access Collision Detection）的英文缩写词。

![CSMA/CD](/public/images/network/03/1-4-3.png)

**CSMA/CD 的基本原理是：所有节点都共享网络传输信道，节点在发送数据之前，首先检测信道是否空闲，如果信道空闲则发送，否则就等待；在发送出信息后，再对冲突进行检测，当发现冲突时，则取消发送。**

1. 假设在主机 B 发送帧的过程中，主机 C 也要发送帧。主机 C 进行载波监听，发现总线空闲 96 比特后立即发送帧，这必然导致碰撞
   ![CSMA/CD](/public/images/network/03/1-4-4.png)
2. 碰撞信号沿总线传播，主机 C 比主机 B 更早检测到碰撞并停止发送，退避一段随机时间后，重新发送之前所发送的帧
   ![CSMA/CD](/public/images/network/03/1-4-5.png)
3. 当主线 B 检测到碰撞后，同样也停止发送退避一段随机时间，重新发送之前所发送的帧
   ![CSMA/CD](/public/images/network/03/1-4-6.png)

**强化碰撞：** 发送帧的站点一旦检测到碰撞，除了立即停止发送帧外，还要再继续发送 **32 比特或 48 比特的人为干扰信号**（Jamming Signal），以便有**足够多的碰撞信号使所有站点都能检测出碰撞**。

- 载波监听检测到总线空闲，但总线**并不一定空闲。**
- 使用 CSMA/CD 协议的共享总线以太网上的各站点，只是尽量避免碰撞并在出现碰撞时做出退避后重发的处理，但**不能完全避免碰撞。**
- 在使用 CSMA/CD 协议时，由于正在发送帧的站点必须“边发送帧边检测碰撞”，因此站点不可能同时进行发送和接收，也就是不可能进行全双工通信，而只能进行**半双工通信**（双向交替通信）。

### 争用期

![CSMA/CD](/public/images/network/03/1-4-7.png)

1. 站点从发送帧开始，最多经过时长 2τ （即 δ→0）就可检测出所发送的帧是否遭遇了碰撞。
2. 共享总线以太网的**端到端往返时间 2τ**被称为争用期（Contention Period）或**碰撞窗口**（Collision Window）。

   - 站点从发送帧开始，**经过争用期 2τ 这段时间还没有检测到碰撞，就可以肯定这次发送不会产生碰撞。**

3. 从争用期的概念可以看出，共享总线以太网上的每一个站点从发送帧开始，到之后的一小段时间内，都有可能遭遇碰撞，**而这一小段时间的长短是不确定的**，它**取决于另一个发送帧的站点与本站点的距离**，但不会超过总线的端到端往返传播时延，即一个争用期 2τ 。
   - 很显然，总线的长度越长（单程端到端传播时延越大），网络中站点数量越多，发生碰撞的概率就越大。
   - 因此，共享以太网的总线长度不能太长（不超过 2500m），接入的站点数量也不能太多。
4. 10Mb/s 共享总线以太网（传统以太网）规定：**争用期 2τ  的值为 512 比特的发送时间，即 51.2μs** 。

### 最小帧长

![CSMA/CD](/public/images/network/03/1-4-8.png)

- 为了确保共享总线以太网上的每一个站点在发送完一个完整的帧之前，能够检测出是否产生了碰撞，**帧的发送时延就不能少于共享总线以太网端到端的往返时间**，即一个争用期 2τ 。
- 对于 10Mb/s 的共享总线以太网，其争用期 2τ  的值规定为 51.2μs，因此其最小帧长为 512b，即 64B。
  - 当某个站点在发送帧时，如果帧的前 64B 没有遭遇碰撞，那么帧的后续部分也就不会遭遇碰撞。也就是说，如果遭遇碰撞，就一定是在帧的前 64B 之内。
  - 由于发送帧的站点边发送帧边检测碰撞，一旦检测到碰撞就立即中止帧的发送，此时已发送的数据量一定小于 64B。因此，接收站点收到长度**小于 64B 的帧**，就可判定这是一个**遭遇了碰撞而异常中止的无效帧**，将其丢弃即可。

### 最大帧长

![CSMA/CD](/public/images/network/03/1-4-9.png)

- **帧的数据载荷的长度应远大于帧首部和尾部的总长度**，这样可以提高帧的传输效率。
- 如果不限制数据载荷的长度上限，就可能使得**帧的长度太长**，这会**带来一些问题**。

### 截断二进制指数退避算法

- 在使用 CSMA/CD 协议的共享总线以太网中，正在发送帧的站点一边发送帧一边检测碰撞，当检测到碰撞时就立即停止发送，**退避一段随机时间**后再重新发送。
- 共享总线以太网中的各站点采用**截断二进制指数退避**（Truncated Binary Exponential Backoff）算法来选择退避的随机时间。

![CSMA/CD](/public/images/network/03/1-4-10.png)

1. 如果连续多次发送碰撞，就表明可能有较多的站点参与竞争信道。但使用上述退避算法可**使重传需要推迟的平均时间随重传次数而增大**（即动态退避），因而**减小产生碰撞的概率**。
2. **当重传达 16 次仍不能成功时**，就表明同时打算发送帧的站点太多，以至于连续产生碰撞，此时应**放弃重传**并向高层报告。

![CSMA/CD](/public/images/network/03/1-4-11.png)

## CSMA/CA 协议

- 对于 802.11 无线局域网，其使用无线信道传输数据，这与共享总线以太网使用有线传输介质不同。因此，802.11 无线局域网不能简单照搬共享总线以太网使用的 CSMA/CD 协议。
- 802.11 无线局域网采用了另一种称为 CSMA/CA 的协议，也就是**载波监听多址接入/碰撞避免**（Carrier Sense Multiple Access/Collision Avoidance，CSMA/CA）。
- CSMA/CA 协议**仍然采用** CSMA/CD 协议中的 CSMA，以“先听后说”的方式来减少碰撞的发生，但是**将“碰撞检测 CD”改为了“碰撞避免 CA”。**
  - 尽管 CA 表示碰撞避免，但并不能避免所有的碰撞，而是尽量减少碰撞发生的概率。

![CSMA/CA](/public/images/network/03/1-5-1.png)

无线局域网不能简单照搬共享总线以太网（有线局域网）使用的 CSMA/CD 协议，而是不再实现碰撞检测 CD 功能，但在 CSMA 的基础上增加碰撞避免 CA 功能，即使用 CSMA/CA 协议。

![CSMA/CA](/public/images/network/03/1-5-2.png)

### CSMA/CA 协议的退避算法

- 在执行退避算法时，站点为退避计时器设置一个随机的退避时间：
  - 当退避计时器的时间减小到零时，就开始发送数据；
  - 当退避计时器的时间还未减小到零时而信道又转变为忙状态，这时就冻结退避计时器的数值，重新等待信道变为空闲，再经过帧间间隔 DIFS 后，继续启动退避计时器。
- 在进行第 i 次退避时，退避时间在时隙编号{0，1，… ，2^2+i−1}中随机选择一个，然后乘以基本退避时间（也就是一个时隙的长度）就可以得到随机的退避时间。当时隙编号达到 255 时（对应于第 6 次退避）就不再增加了。

![CSMA/CA](/public/images/network/03/1-5-3.png)
