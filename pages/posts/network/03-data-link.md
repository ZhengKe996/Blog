---
title: '数据链路层'
date: 2023-11-02
type: NetWork
---

## 数据链路层概述

- **链路（Link）**是指从一个节点到相邻节点的一段物理线路（有线或无线），而**中间没有任何其他的交换节点**。
- 数据链路（Data Link）是基于链路的。当在一条链路上传送数据时，除需要链路本身，还需要一些必要的通信协议来控制这些数据的传输，**把实现这些协议的硬件和软件加到链路上**，就构成了数据链路。
- 计算机中的**网络适配器**（俗称网卡）和其相应的软件驱动程序就实现了这些协议。一般的**网络适配器都包含了物理层和数据链路层这两层的功能**。
- 帧（Frame）是**数据链路层**对等实体之间在水平方向进行逻辑通信的协议数据单元 **PDU**。

## 数据链路层的三个重要问题

### 封装成帧

- 封装成帧是指数据链路层给上层交付下来的协议数据单元 PDU 添加一个首部和一个尾部，使之成为帧。

  - 帧的首部和尾部中包含有一些**重要的控制信息**。
  - 帧首部和尾部的作用之一就是**帧定界**。
  - `[注]` 并不是每一种数据链路层协议的帧都包含有帧定界标志。
  - 帧间间隔（发送 96 比特所耗费的时间）

- 为了提高数据链路层传输帧的效率，应当使**帧的数据载荷的长度尽可能地大于首部和尾部的长度**。
- 考虑到对缓存空间的需求以及差错控制等诸多因素，每一种数据链路层协议都规定了帧的数据载荷的长度上限，即**最大传送单元**（Maximum Transfer Unit，MTU）。例如，以太网的 MTU 为 1500 个字节。

![封装成帧](/public/images/network/03/1-1-1.png)
![封装成帧](/public/images/network/03/1-1-2.png)

![帧定界](/public/images/network/03/1-1-3.png)

### 透明传输

透明传输是指**数据链路层对上层交付下来的协议数据单元 PDU 没有任何限制**，就好像数据链路层不存在一样。

- 面向字节的物理链路使用**字节填充**的方法实现透明传输。
- 面向比特的物理链路使用**比特填充**的方法实现透明传输。(零比特填充：每 5 个 1 后插入一个 0)

![透明传输](/public/images/network/03/1-1-5.png)

### 差错检测

- 帧在传输的过程中可能出现误码。
- 接收方根据发送方添加在帧尾部中的检错码，可以检测出帧是否出现了误码。

#### 误码的相关概念

- 实际的通信链路都不是理想的，比特在传输过程中可能会产生差错（称为**比特差错**）
  - 比特 1 可能变成比特 0
  - 比特 0 可能变成比特 1
- 在一段时间内，传输错误的比特数量占所传输比特总数的比率称为**误码率**（Bit Error Rate，BER）。
- **提高链路的信噪比**，可以**降低误码率**。但在实际的通信链路上，不可能使误码率下降为零。
- 使用**差错检测技术**来检测数据在传输过程中是否产生了比特差错，是数据链路层所要解决的重要问题之一。

![差错检测](/public/images/network/03/1-1-6.png)

#### 奇偶校验

- 奇校验是在待发送的数据后面**添加 1 个校验位**，使得添加该校验位后的整个数据中**比特 1 的个数为奇数**。
- 偶校验是在待发送的数据后面**添加 1 个校验位**，使得添加该校验位后的整个数据中**比特 1 的个数为偶数**。
- 在所传输的数据中，如果有**奇数个位发生误码**，则所包含比特 1 的数量的奇偶性会发生改变，**可以检测出误码**。
- 在所传输的数据中，如果有**偶数个位发生误码**，则所包含比特 1 的数量的奇偶性不会发生改变，**无法检测出误码（漏检）**。
- 在实际使用时，奇偶校验又可分为垂直奇偶校验、水平奇偶校验以及水平垂直奇偶校验。

#### 循环冗余校验（CRC）

- 数据链路层广泛使用漏检率极低的循环冗余校验（Cyclic Redundancy Check，CRC）检错技术。

  - 收发双方约定好一个生成多项式 G(X)。
  - 发送方基于待发送的数据和**生成多项式 G(X)**，计算出差错检测码（冗余码），将冗余码添加到待发送数据的后面一起传输。
  - 接收方收到数据和冗余码后，通过生成多项式 G(X)来计算收到的数据和冗余码是否产生了误码。

![CRC](/public/images/network/03/1-1-7.png)
![CRC](/public/images/network/03/1-1-8.png)

### 可靠传输

- 不可靠传输服务：收到有误码的帧，直接丢弃，其他什么也不做；未收到发送方发送的帧，也不进行任何处理。
- 可靠传输服务：实现发送方发送什么，接收方最终都能正确收到。
- 一般情况下，**有线链路的误码率比较低**。为了减小开销，**并不要求数据链路层向其上层提供可靠传输服务**。即使出现了误码，可靠传输的问题由其上层处理。
- **无线链路**易受干扰，**误码率比较高**，因此**要求数据链路层必须向其上层提供可靠传输服务**。

#### 传输差错

1. **误码（比特差错）**
2. **分组丢失**：输入队列快满了，主动丢弃收到的分组
3. **分组失序**：分组到达顺序与发送顺序不同
4. **分组重复**：路由器繁忙，分组在输入队列中等待较长时间，导致发送方重发，使得接收方收到了重复分组。

![传输差错](/public/images/network/03/1-2-1.png)

**`[注意📢]`**

- **可靠传输服务并不局限于数据链路层**，其他各层均可选择实现可靠传输。
- 可靠传输的实现比较复杂，开销比较大，是否使用可靠传输取决于应用需求。

![传输差错](/public/images/network/03/1-2-2.png)

#### 停止-等待协议

![传输差错](/public/images/network/03/1-2-3.png)

**`[注意📢]`**

- 使用超时重传机制后，就可以不使用否认机制了，这样可使协议实现起来更加简单。但是，如果点对点链路的误码率较高，**使用否认机制可以使发送方在超时计时器超时前就尽快重传。**
- 为了让接收方能够判断所收到的数据分组是否是重复的，需要给**数据分组编号**。由于**停止-等待协议**的特性，**只需 1 个比特编序号**即可，即序号 0 和序号 1。
- 为了让发送方能够判断所收到的确认分组是否是重复的，需要给**确认分组编号**，所用比特数量与**数据分组所用比特数量一样**。

  - 数据链路层一般不会出现确认分组迟到的情况，**因此在数据链路层实现停止-等待协议可以不用给确认分组编号**。

- 给超时计时器设置的超时重传时间 RTO 应当仔细选择，**一般将 RTO 设置为略大于收发双方的平均往返时间 RTT**。

  - 在数据链路层，点对点的往返时间 RTT 比较固定，RTO 就比较好设定。
  - 在运输层，由于端到端往返时间非常不确定，设置合适的超时重传时间 RTO 有时并不容易。

- 停止-等待协议属于自动请求重传（Automatic Repeat reQuest，**ARQ**）协议。即重传的请求是发送方自动进行的，而不是接收方请求发送方重传某个误码的数据分组。

![传输差错](/public/images/network/03/1-2-4.png)

- 若出现超时重传，对于传送有用的数据信息来说，信道利用率还要降低。
- 在往返时间 RTT 相对较大的情况下，为了提高信道利用率，收发双方不适合采用停止-等待协议，而可以选择使用回退 N 帧（GBN）协议或选择重传（SR）协议。

#### 回退 N 帧协议

**采用流水线传输可以显著提高信道利用率**
![传输差错](/public/images/network/03/1-2-5.png)

<hr />

![传输差错](/public/images/network/03/1-2-6.png)

#### 选择重传协议

![传输差错](/public/images/network/03/1-2-7.png)

为了使发送方仅重传出现差错的数据分组，接收方不再采用**累积确认**，而需要对每一个正确接收的数据分组进行**逐一确认**。

![传输差错](/public/images/network/03/1-2-8.png)

## 点对点协议(PPP)

- 点对点协议（Point-to-Point Protocol，PPP）是目前使用最广泛的点对点数据链路层协议。
- 点对点协议 PPP 是因特网工程任务组（Internet Engineering Task Force，IETF）于 1992 年制定的。经过多次修订，目前 PPP 已成为因特网的正式标准[RFC1661，RFC1662]。

### PPP 的帧格式

![点对点协议](/public/images/network/03/1-3-1.png)

- 面向字节的异步链路使用字节填充来实现透明传输`[RFC1662]`
- 发送方的处理：

  1. 将数据载荷中出现的每一个 0x7E 减去 0x20（相当于异或 0x20），然后在其前面插入转义字符 0x7D。
  2. 若数据载荷中原来就含有 0x7D，则把每一个 0x7D 减去 0x20，然后在其前面插入转义字符 0x7D。
  3. 将数据载荷中出现的每一个 ASCII 码控制字符（即数值小于 0x20 的字符），加上 0x20（相当于异或 0x20，将其转换成非控制字符），然后在其前面插入转义字符 0x7D。
  4. 对帧的数据载荷进行扫描（一般由硬件完成），每出现 5 个连续的比特 1，则在其后填充一个比特 0。(零比特填充法)

- 接收方的处理：

  1. 进行与发送方**相反的变换**，就可以正确地恢复出未经过字节填充的原始数据载荷。
  2. 对帧的数据载荷进行扫描，每出现 5 个连续的比特 1 时，就把其后的一个比特 0 删除。

- 帧检验序列 FCS 字段：
  1. 其值是使用循环冗余校验 CRC 计算出的检错码。
  2. CRC 采用的生成多项式为  `CRC−CCITT=X^16+X^12+X^5+1`

**`[注意📢]`**

使用 PPP 的数据链路层，**向上提供的是不可靠数据传输服务**。
![点对点协议](/public/images/network/03/1-3-2.png)
