---
title: orm gorm ğŸ“’
date: 2022-08-09
draft: true
type: GoLang
lang: zh
duration: 15min
---

![orm](/public/images/orm-study/1-1.png)

## ä»€ä¹ˆæ˜¯ orm?

ORM å…¨ç§°æ˜¯ï¼šObject Relational Mapping(å¯¹è±¡å…³ç³»æ˜ å°„)ï¼Œå…¶ä¸»è¦ä½œç”¨æ˜¯åœ¨ç¼–ç¨‹ä¸­ï¼ŒæŠŠé¢å‘å¯¹è±¡çš„æ¦‚å¿µè·Ÿæ•°æ®åº“ä¸­è¡¨çš„æ¦‚å¿µå¯¹åº”èµ·æ¥ã€‚ä¸¾ä¾‹æ¥è¯´å°±æ˜¯ï¼Œæˆ‘å®šä¹‰ä¸€ä¸ªå¯¹è±¡ï¼Œé‚£å°±å¯¹åº”ç€ä¸€å¼ è¡¨ï¼Œè¿™ä¸ªå¯¹è±¡çš„å®ä¾‹ï¼Œå°±å¯¹åº”ç€è¡¨ä¸­çš„ä¸€æ¡è®°å½•ã€‚é’ˆå¯¹ go è¯­è¨€è€Œè¨€æ˜¯æ˜ å°„æˆ structï¼Œåˆ—å¯ä»¥æ˜ å°„æˆ struct ä¸­çš„ç±»å‹ï¼Œå­˜åœ¨çš„é—®é¢˜ï¼šæ•°æ®åº“ä¸­çš„åˆ—å…·å¤‡å¾ˆå¥½çš„æè¿°æ€§ï¼Œéœ€è¦ä½¿ç”¨ struct ä¸­çš„ tagã€‚

å¯¹äºæ•°æ®æ¥è¯´ï¼Œæœ€é‡è¦æœ€å¸¸ç”¨çš„æ˜¯è¡¨ï¼šè¡¨ä¸­æœ‰åˆ—ï¼Œorm å°±æ˜¯å°†ä¸€å¼ è¡¨æ˜ å°„æˆä¸€ä¸ªç±»ï¼Œè¡¨ä¸­çš„åˆ—æ˜ å°„æˆç±»ä¸­çš„ä¸€ä¸ªç±»ã€‚

## orm çš„ä¼˜ç¼ºç‚¹

#### ä¼˜ç‚¹ï¼š

1. æé«˜äº†å¼€å‘æ•ˆç‡ã€‚
2. å±è”½ sql ç»†èŠ‚ã€‚å¯ä»¥è‡ªåŠ¨å¯¹å®ä½“ Entity å¯¹è±¡ä¸æ•°æ®åº“ä¸­çš„ Table è¿›è¡Œå­—æ®µä¸å±æ€§çš„æ˜ å°„ï¼›ä¸ç”¨ç›´æ¥ SQL ç¼–ç 
3. å±è”½å„ç§æ•°æ®åº“ä¹‹é—´çš„å·®å¼‚

#### ç¼ºç‚¹ï¼š

1. orm ä¼šç‰ºç‰²ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡å’Œä¼šå›ºå®šæ€ç»´æ¨¡å¼
2. å¤ªè¿‡ä¾èµ– orm ä¼šå¯¼è‡´ sql ç†è§£ä¸å¤Ÿ
3. å¯¹äºå›ºå®šçš„ orm ä¾èµ–è¿‡é‡ï¼Œå¯¼è‡´åˆ‡æ¢åˆ°å…¶ä»–çš„ orm ä»£ä»·é«˜

## å¦‚ä½•æ­£ç¡®çœ‹å¾… orm å’Œ sql ä¹‹é—´çš„å…³ç³»

1. sql ä¸ºä¸»ï¼Œorm ä¸ºè¾…
2. orm ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†å¢åŠ ä»£ç å¯ç»´æŠ¤æ€§å’Œå¼€å‘æ•ˆç‡

## gorm è¿æ¥ mysql

[å®˜æ–¹æ–‡æ¡£](https://gorm.io/zh_CN/docs/connecting_to_the_database.html)

```go
	dsn := "ç”¨æˆ·å:å¯†ç @tcp(127.0.0.1:3306)/æ•°æ®åº“å?charset=utf8mb4&parseTime=True&loc=Local"
	db, err := gorm.Open(mysql.Open(dsn), &gorm.Config{})
	if err != nil {
		panic(err)
	}
```

## gorm æ‰“å°æ—¥å¿—

[å®˜æ–¹æ–‡æ¡£](https://gorm.io/zh_CN/docs/logger.html)

```go
	newLogger := logger.New(
		log.New(os.Stdout, "\r\n", log.LstdFlags), // io writerï¼ˆæ—¥å¿—è¾“å‡ºçš„ç›®æ ‡ï¼Œå‰ç¼€å’Œæ—¥å¿—åŒ…å«çš„å†…å®¹â€”â€”è¯‘è€…æ³¨ï¼‰
		logger.Config{
			SlowThreshold:             time.Second,   // æ…¢ SQL é˜ˆå€¼
			LogLevel:                  logger.Silent, // æ—¥å¿—çº§åˆ«
			IgnoreRecordNotFoundError: true,          // å¿½ç•¥ErrRecordNotFoundï¼ˆè®°å½•æœªæ‰¾åˆ°ï¼‰é”™è¯¯
			Colorful:                  false,         // ç¦ç”¨å½©è‰²æ‰“å°
		},
	)
  // ...
  db, err := gorm.Open(mysql.Open(dsn), &gorm.Config{
		// è®¾ç½®å…¨å±€çš„logger
		Logger: newLogger,
	})
```

## gorm å£°æ˜æ¨¡å‹

```go
  type Product struct {
    gorm.Model
    Code  string
    Price uint
  }
```

## gorm ç”Ÿæˆè¡¨ç»“æ„

```go
  err = db.AutoMigrate(&Product{})
```

![ç”Ÿæˆè¡¨ç»“æ„](/public/images/orm-study/1-2.png)
![ç”Ÿæˆè¡¨ç»“æ„](/public/images/orm-study/1-3.png)

## gorm å®ç° CURD

#### æ–°å¢

```go
	db.Create(&Product{Code: "D42", Price: 100})
```

#### æŸ¥è¯¢

```go
	var product Product // æ³¨æ„ï¼šä¼ å…¥çš„æ˜¯æŒ‡é’ˆ
	db.First(&product, 1) // æ ¹æ®æ•´å‹ä¸»é”®æŸ¥æ‰¾
	db.First(&product, "code = ?", "D42") // æŸ¥æ‰¾ code å­—æ®µå€¼ä¸º D42 çš„è®°å½•

  fmt.Println(product.Code) // D42
```

#### æ›´æ–°

```go
	var product Product // æ³¨æ„ï¼šéœ€è¦ä¸æŸ¥è¯¢è¯­å¥é…åˆä½¿ç”¨
	db.Model(&product).Update("Price", 200) // å°† product çš„ price æ›´æ–°ä¸º 200

  // Update - æ›´æ–°å¤šä¸ªå­—æ®µ
	db.Model(&product).Updates(Product{Price: 200, Code: "F42"}) // ä»…æ›´æ–°éé›¶å€¼å­—æ®µï¼Œéœ€è¦ä¼ é›¶å€¼å¾—è®¾ç½®æ¨¡å‹ç±»å‹
	db.Model(&product).Updates(map[string]interface{}{"Price": 200, "Code": "F42"})

```

#### åˆ é™¤ï¼ˆéç‰©ç†åˆ é™¤ï¼‰

```go
	db.Delete(&product, 1) // ä¼ å…¥ä¸»é”®å€¼
```

## gorm updates è¡¥å……

#### updates ä»…æ›´æ–°éé›¶å€¼å­—æ®µ

```go
	db.Model(&User{ID: 1}).Updates(User{Name: ""}) // ä»…æ›´æ–°éé›¶å€¼å­—æ®µ
```

```bash
UPDATE `users` SET `updated_at`='2022-08-10 14:45:16.553' WHERE `id` = 1
```

#### è§£å†³ä»…æ›´æ–°éé›¶å€¼å­—æ®µçš„æ–¹æ³•ï¼šä½¿ç”¨æŒ‡é’ˆ

```go
  type User struct {
    ID           uint
    Name         *string
  }


	empty := ""
	db.Model(&User{ID: 1}).Updates(User{Name: &empty})
```

```bash
[9.998ms] [rows:1] UPDATE `users` SET `name`='',`updated_at`='2022-08-10 14:52:22.937' WHERE `id` = 1
```

#### è§£å†³ä»…æ›´æ–°éé›¶å€¼å­—æ®µçš„æ–¹æ³•ï¼šä½¿ç”¨ sel çš„ NULL

```go
type User struct {
	ID           uint
	Name         sql.NullString
}

	db.Model(&User{ID: 1}).Updates(User{Name: sql.NullString{"", true}})
```

```bash
[8.948ms] [rows:1] UPDATE `users` SET `name`='',`updated_at`='2022-08-10 14:57:50.169' WHERE `id` = 1
```

## gorm æ’å…¥è¯­å¥åˆ†æ‰¹æ¬¡

ä¸ºä»€ä¹ˆä¸ä¸€æ¬¡æ€§æäº¤æ‰€æœ‰çš„ è¿˜è¦åˆ†æ‰¹æ¬¡?
å› ä¸º sql è¯­å¥æœ‰é•¿åº¦é™åˆ¶

```go
	var users = []User{{Name: "zhangsan1"}, {Name: "zhangsan2"}, {Name: "zhangsan3"},{Name: "zhangsan4"}}
  db.CreateInBatches(users, 2)
```

## gorm æŸ¥è¯¢

[å®˜æ–¹æ–‡æ¡£](https://gorm.io/zh_CN/docs/query.html)
GORM æä¾›äº† Firstã€Takeã€Last æ–¹æ³•ï¼Œä»¥ä¾¿ä»æ•°æ®åº“ä¸­æ£€ç´¢å•ä¸ªå¯¹è±¡ã€‚å½“æŸ¥è¯¢æ•°æ®åº“æ—¶å®ƒæ·»åŠ äº† LIMIT 1 æ¡ä»¶ï¼Œä¸”æ²¡æœ‰æ‰¾åˆ°è®°å½•æ—¶ï¼Œå®ƒä¼šè¿”å› ErrRecordNotFound é”™è¯¯

#### æ£€ç´¢å•ä¸ªå¯¹è±¡

```go
// è·å–ç¬¬ä¸€æ¡è®°å½•ï¼ˆä¸»é”®å‡åºï¼‰
db.First(&user)
// SELECT * FROM users ORDER BY id LIMIT 1;

// è·å–ä¸€æ¡è®°å½•ï¼Œæ²¡æœ‰æŒ‡å®šæ’åºå­—æ®µ
db.Take(&user)
// SELECT * FROM users LIMIT 1;

// è·å–æœ€åä¸€æ¡è®°å½•ï¼ˆä¸»é”®é™åºï¼‰
db.Last(&user)
// SELECT * FROM users ORDER BY id DESC LIMIT 1;


result := db.First(&user)
result.RowsAffected // è¿”å›æ‰¾åˆ°çš„è®°å½•æ•°
result.Error        // returns error or nil

// æ£€æŸ¥ ErrRecordNotFound é”™è¯¯
errors.Is(result.Error, gorm.ErrRecordNotFound)
```

#### ç”¨ä¸»é”®æ£€ç´¢

```go
db.First(&user, 10)
// SELECT * FROM users WHERE id = 10;

db.First(&user, "10")
// SELECT * FROM users WHERE id = 10;

db.Find(&users, []int{1,2,3})
// SELECT * FROM users WHERE id IN (1,2,3);

// å¦‚æœä¸»é”®æ˜¯å­—ç¬¦ä¸²ï¼ˆä¾‹å¦‚åƒ uuidï¼‰ï¼ŒæŸ¥è¯¢å°†è¢«å†™æˆè¿™æ ·ï¼š
db.First(&user, "id = ?", "1b74413f-f3b8-409f-ac47-e8c062e3472a")
// SELECT * FROM users WHERE id = "1b74413f-f3b8-409f-ac47-e8c062e3472a";

// å½“ç›®æ ‡å¯¹è±¡æœ‰ä¸€ä¸ªä¸»å€¼æ—¶ï¼Œä¸»é”®å°†ç”¨äºæ„å»ºæ¡ä»¶ï¼Œä¾‹å¦‚:
var user = User{ID: 10}
db.First(&user)
// SELECT * FROM users WHERE id = 10;

var result User
db.Model(User{ID: 10}).First(&result)
// SELECT * FROM users WHERE id = 10;
```

#### æ£€ç´¢å…¨éƒ¨å¯¹è±¡

```go
result := db.Find(&users)
// SELECT * FROM users;
```

#### æ¡ä»¶æ£€ç´¢

æŸ¥è¯¢æ¡ä»¶æ–¹å¼æœ‰ä¸‰ç§:

1. string
2. struct
3. map

```go
// è·å–ç¬¬ä¸€ä¸ªåŒ¹é…çš„è®°å½•
db.Where("name = ?", "zhangsan").First(&user)
// SELECT * FROM users WHERE name = 'zhangsan' ORDER BY id LIMIT 1;

// è·å–æ‰€æœ‰åŒ¹é…çš„è®°å½•
db.Where("name <> ?", "zhangsan").Find(&users)
// SELECT * FROM users WHERE name <> 'zhang'san';

// åœ¨ç»™å‡ºèŒƒå›´å†…æŸ¥è¯¢
db.Where("name IN ?", []string{"zhangsan", "zhangsan 2"}).Find(&users)
// SELECT * FROM users WHERE name IN ('zhangsan','zhangsan 2');

// æ¨¡ç³ŠæŸ¥è¯¢
db.Where("name LIKE ?", "%jin%").Find(&users)
// SELECT * FROM users WHERE name LIKE '%jin%';

// å¤šæ¡ä»¶æŸ¥è¯¢
db.Where("name = ? AND age >= ?", "zhangsan", "22").Find(&users)
// SELECT * FROM users WHERE name = 'zhangsan' AND age >= 22;

// æ ¹æ®æ—¶é—´æŸ¥è¯¢
db.Where("updated_at > ?", lastWeek).Find(&users)
// SELECT * FROM users WHERE updated_at > '2000-01-01 00:00:00';

// æ ¹æ®æ—¶é—´èŒƒå›´æŸ¥è¯¢
db.Where("created_at BETWEEN ? AND ?", lastWeek, today).Find(&users)
// SELECT * FROM users WHERE created_at BETWEEN '2000-01-01 00:00:00' AND '2000-01-08 00:00:00';


// ä¼ å…¥ç»“æ„ä½“æŸ¥è¯¢
// æ³¨æ„:å½“ä½¿ç”¨structè¿›è¡ŒæŸ¥è¯¢æ—¶ï¼ŒGORMåªä¼šä½¿ç”¨éé›¶å­—æ®µè¿›è¡ŒæŸ¥è¯¢ï¼Œè¿™æ„å‘³ç€å¦‚æœä½ çš„å­—æ®µå€¼ä¸º0ï¼Œ"ï¼Œfalseæˆ–å…¶ä»–é›¶å€¼ï¼Œå®ƒå°†ä¸ä¼šè¢«ç”¨äºæ„å»ºæŸ¥è¯¢æ¡ä»¶
db.Where(&User{Name: "jinzhu", Age: 20}).First(&user)
// SELECT * FROM users WHERE name = "jinzhu" AND age = 20 ORDER BY id LIMIT 1;

// ä¼ å…¥MapæŸ¥è¯¢
// è¦åœ¨æŸ¥è¯¢æ¡ä»¶ä¸­åŒ…å«0å€¼ï¼Œå¯ä»¥ä½¿ç”¨mapï¼Œå®ƒå°†åŒ…å«æ‰€æœ‰é”®å€¼ä½œä¸ºæŸ¥è¯¢æ¡ä»¶
db.Where(map[string]interface{}{"name": "jinzhu", "age": 20}).Find(&users)
// SELECT * FROM users WHERE name = "jinzhu" AND age = 20;

// æ ¹æ®ä¸»é”®åˆ‡ç‰‡æŸ¥è¯¢
db.Where([]int64{20, 21, 22}).Find(&users)
// SELECT * FROM users WHERE id IN (20, 21, 22);
```

#### æŒ‡å®šç»“æ„ä½“æŸ¥è¯¢å­—æ®µ

å½“ä½¿ç”¨ struct è¿›è¡Œæ£€ç´¢æ—¶ï¼Œå¯ä»¥é€šè¿‡å°†ç›¸å…³å­—æ®µåæˆ– dbname ä¼ é€’ç»™ Where()æ¥æŒ‡å®šåœ¨æŸ¥è¯¢æ¡ä»¶ä¸­ä½¿ç”¨çš„ struct ä¸­çš„ç‰¹å®šå€¼

```go
db.Where(&User{Name: "jinzhu"}, "name", "Age").Find(&users)
// SELECT * FROM users WHERE name = "jinzhu" AND age = 0;

db.Where(&User{Name: "jinzhu"}, "Age").Find(&users)
// SELECT * FROM users WHERE age = 0;
```

#### é€‰æ‹©ç‰¹å®šå­—æ®µ

é€‰æ‹©å…è®¸æŒ‡å®šè¦ä»æ•°æ®åº“æ£€ç´¢çš„å­—æ®µã€‚å¦åˆ™ï¼ŒGORM å°†é»˜è®¤é€‰æ‹©æ‰€æœ‰å­—æ®µã€‚

```go
db.Select("name", "age").Find(&users)
// SELECT name, age FROM users;

db.Select([]string{"name", "age"}).Find(&users)
// SELECT name, age FROM users;

db.Table("users").Select("COALESCE(age,?)", 42).Rows()
// SELECT COALESCE(age,'42') FROM users;
```

#### Order & Limit & Offset

Order:æŒ‡å®šä»æ•°æ®åº“æ£€ç´¢è®°å½•æ—¶çš„é¡ºåº

```go
db.Order("age desc, name").Find(&users)
// SELECT * FROM users ORDER BY age desc, name;

// Multiple orders
db.Order("age desc").Order("name").Find(&users)
// SELECT * FROM users ORDER BY age desc, name;

db.Clauses(clause.OrderBy{
  Expression: clause.Expr{SQL: "FIELD(id,?)", Vars: []interface{}{[]int{1, 2, 3}}, WithoutParentheses: true},
}).Find(&User{})
// SELECT * FROM users ORDER BY FIELD(id,1,2,3)
```

Limit:æŒ‡å®šè¦æ£€ç´¢çš„æœ€å¤§è®°å½•æ•°ã€‚
Offset:æŒ‡å®šåœ¨å¼€å§‹è¿”å›è®°å½•ä¹‹å‰è¦è·³è¿‡çš„è®°å½•æ•°

```go
db.Limit(3).Find(&users)
// SELECT * FROM users LIMIT 3;

// Cancel limit condition with -1
db.Limit(10).Find(&users1).Limit(-1).Find(&users2)
// SELECT * FROM users LIMIT 10; (users1)
// SELECT * FROM users; (users2)

db.Offset(3).Find(&users)
// SELECT * FROM users OFFSET 3;

db.Limit(10).Offset(5).Find(&users)
// SELECT * FROM users OFFSET 5 LIMIT 10;

// Cancel offset condition with -1
db.Offset(10).Find(&users1).Offset(-1).Find(&users2)
// SELECT * FROM users OFFSET 10; (users1)
// SELECT * FROM users; (users2)
```

## gorm æ›´æ–°

Save ä¼šä¿å­˜æ‰€æœ‰çš„å­—æ®µï¼Œå³ä½¿å­—æ®µæ˜¯é›¶å€¼

```go
db.First(&user)
user.Name = "jinzhu 2"
user.Age = 100
db.Save(&user)
// UPDATE users SET name='jinzhu 2', age=100, birthday='2000-01-01', updated_at = '2000-11-11' WHERE id=111;
```

#### æ›´æ–°å•ä¸ªåˆ—

```go
db.Model(&User{}).Where("active = ?", true).Update("name", "hello")
// UPDATE users SET name='hello', updated_at='2000-11-17' WHERE active=true;
```

#### æ›´æ–°å¤šåˆ—

å½“ä½¿ç”¨ struct æ›´æ–°æ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒGORM åªä¼šæ›´æ–°éé›¶å€¼çš„å­—æ®µ

```go
// æ ¹æ® `struct` æ›´æ–°å±æ€§ï¼Œåªä¼šæ›´æ–°éé›¶å€¼çš„å­—æ®µ
db.Model(&user).Updates(User{Name: "hello", Age: 18, Active: false})
// UPDATE users SET name='hello', age=18, updated_at = '2000-11-17' WHERE id = 111;

// æ ¹æ® `map` æ›´æ–°å±æ€§
db.Model(&user).Updates(map[string]interface{}{"name": "hello", "age": 18, "active": false})
// UPDATE users SET name='hello', age=18, active=false, updated_at='2000-11-17' WHERE id=111;
```

## gorm åˆ é™¤

åˆ é™¤ä¸€æ¡è®°å½•æ—¶ï¼Œåˆ é™¤å¯¹è±¡éœ€è¦æŒ‡å®šä¸»é”®ï¼Œå¦åˆ™ä¼šè§¦å‘ æ‰¹é‡ Delete

#### è½¯åˆ é™¤

æ¨¡å‹åŒ…å«äº†ä¸€ä¸ª gorm.deletedat å­—æ®µï¼ˆgorm.Model å·²ç»åŒ…å«äº†è¯¥å­—æ®µ)ï¼Œå®ƒå°†è‡ªåŠ¨è·å¾—è½¯åˆ é™¤çš„èƒ½åŠ›
æ‹¥æœ‰è½¯åˆ é™¤èƒ½åŠ›çš„æ¨¡å‹è°ƒç”¨ Delete æ—¶ï¼Œè®°å½•ä¸ä¼šä»æ•°æ®åº“ä¸­è¢«çœŸæ­£åˆ é™¤ã€‚ä½† GORM ä¼šå°† DeletedAt ç½®ä¸ºå½“å‰æ—¶é—´ï¼Œ å¹¶ä¸”ä½ ä¸èƒ½å†é€šè¿‡æ™®é€šçš„æŸ¥è¯¢æ–¹æ³•æ‰¾åˆ°è¯¥è®°å½•ã€‚

```go
// user çš„ ID æ˜¯ `111`
db.Delete(&user)
// UPDATE users SET deleted_at="2013-10-29 10:23" WHERE id = 111;

// æ‰¹é‡åˆ é™¤
db.Where("age = ?", 20).Delete(&User{})
// UPDATE users SET deleted_at="2013-10-29 10:23" WHERE age = 20;

// åœ¨æŸ¥è¯¢æ—¶ä¼šå¿½ç•¥è¢«è½¯åˆ é™¤çš„è®°å½•
db.Where("age = 20").Find(&user)
// SELECT * FROM users WHERE age = 20 AND deleted_at IS NULL;
```

#### æ°¸ä¹…åˆ é™¤

```go
db.Unscoped().Delete(&order)
// DELETE FROM orders WHERE id=10;
```
