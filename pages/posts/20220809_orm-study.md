---
title: orm gorm ğŸ“’
date: 2022-08-06
draft: true
lang: zh
duration: 15min
---

![orm](/public/images/orm-study/1-1.png)

## ä»€ä¹ˆæ˜¯ orm?

ORM å…¨ç§°æ˜¯ï¼šObject Relational Mapping(å¯¹è±¡å…³ç³»æ˜ å°„)ï¼Œå…¶ä¸»è¦ä½œç”¨æ˜¯åœ¨ç¼–ç¨‹ä¸­ï¼ŒæŠŠé¢å‘å¯¹è±¡çš„æ¦‚å¿µè·Ÿæ•°æ®åº“ä¸­è¡¨çš„æ¦‚å¿µå¯¹åº”èµ·æ¥ã€‚ä¸¾ä¾‹æ¥è¯´å°±æ˜¯ï¼Œæˆ‘å®šä¹‰ä¸€ä¸ªå¯¹è±¡ï¼Œé‚£å°±å¯¹åº”ç€ä¸€å¼ è¡¨ï¼Œè¿™ä¸ªå¯¹è±¡çš„å®ä¾‹ï¼Œå°±å¯¹åº”ç€è¡¨ä¸­çš„ä¸€æ¡è®°å½•ã€‚é’ˆå¯¹ go è¯­è¨€è€Œè¨€æ˜¯æ˜ å°„æˆ structï¼Œåˆ—å¯ä»¥æ˜ å°„æˆ struct ä¸­çš„ç±»å‹ï¼Œå­˜åœ¨çš„é—®é¢˜ï¼šæ•°æ®åº“ä¸­çš„åˆ—å…·å¤‡å¾ˆå¥½çš„æè¿°æ€§ï¼Œéœ€è¦ä½¿ç”¨ struct ä¸­çš„ tagã€‚

å¯¹äºæ•°æ®æ¥è¯´ï¼Œæœ€é‡è¦æœ€å¸¸ç”¨çš„æ˜¯è¡¨ï¼šè¡¨ä¸­æœ‰åˆ—ï¼Œorm å°±æ˜¯å°†ä¸€å¼ è¡¨æ˜ å°„æˆä¸€ä¸ªç±»ï¼Œè¡¨ä¸­çš„åˆ—æ˜ å°„æˆç±»ä¸­çš„ä¸€ä¸ªç±»ã€‚

## orm çš„ä¼˜ç¼ºç‚¹

#### ä¼˜ç‚¹ï¼š

1. æé«˜äº†å¼€å‘æ•ˆç‡ã€‚
2. å±è”½ sql ç»†èŠ‚ã€‚å¯ä»¥è‡ªåŠ¨å¯¹å®ä½“ Entity å¯¹è±¡ä¸æ•°æ®åº“ä¸­çš„ Table è¿›è¡Œå­—æ®µä¸å±æ€§çš„æ˜ å°„ï¼›ä¸ç”¨ç›´æ¥ SQL ç¼–ç 
3. å±è”½å„ç§æ•°æ®åº“ä¹‹é—´çš„å·®å¼‚

#### ç¼ºç‚¹ï¼š

1. orm ä¼šç‰ºç‰²ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡å’Œä¼šå›ºå®šæ€ç»´æ¨¡å¼
2. å¤ªè¿‡ä¾èµ– orm ä¼šå¯¼è‡´ sql ç†è§£ä¸å¤Ÿ
3. å¯¹äºå›ºå®šçš„ orm ä¾èµ–è¿‡é‡ï¼Œå¯¼è‡´åˆ‡æ¢åˆ°å…¶ä»–çš„ orm ä»£ä»·é«˜

## å¦‚ä½•æ­£ç¡®çœ‹å¾… orm å’Œ sql ä¹‹é—´çš„å…³ç³»

1. sql ä¸ºä¸»ï¼Œorm ä¸ºè¾…
2. orm ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†å¢åŠ ä»£ç å¯ç»´æŠ¤æ€§å’Œå¼€å‘æ•ˆç‡

## gorm è¿æ¥ mysql

[å®˜æ–¹æ–‡æ¡£](https://gorm.io/zh_CN/docs/connecting_to_the_database.html)

```go
	dsn := "ç”¨æˆ·å:å¯†ç @tcp(127.0.0.1:3306)/æ•°æ®åº“å?charset=utf8mb4&parseTime=True&loc=Local"
	db, err := gorm.Open(mysql.Open(dsn), &gorm.Config{})
	if err != nil {
		panic(err)
	}
```

## gorm æ‰“å°æ—¥å¿—

[å®˜æ–¹æ–‡æ¡£](https://gorm.io/zh_CN/docs/logger.html)

```go
	newLogger := logger.New(
		log.New(os.Stdout, "\r\n", log.LstdFlags), // io writerï¼ˆæ—¥å¿—è¾“å‡ºçš„ç›®æ ‡ï¼Œå‰ç¼€å’Œæ—¥å¿—åŒ…å«çš„å†…å®¹â€”â€”è¯‘è€…æ³¨ï¼‰
		logger.Config{
			SlowThreshold:             time.Second,   // æ…¢ SQL é˜ˆå€¼
			LogLevel:                  logger.Silent, // æ—¥å¿—çº§åˆ«
			IgnoreRecordNotFoundError: true,          // å¿½ç•¥ErrRecordNotFoundï¼ˆè®°å½•æœªæ‰¾åˆ°ï¼‰é”™è¯¯
			Colorful:                  false,         // ç¦ç”¨å½©è‰²æ‰“å°
		},
	)
  // ...
  db, err := gorm.Open(mysql.Open(dsn), &gorm.Config{
		// è®¾ç½®å…¨å±€çš„logger
		Logger: newLogger,
	})
```

## gorm å£°æ˜æ¨¡å‹

```go
  type Product struct {
    gorm.Model
    Code  string
    Price uint
  }
```

## gorm ç”Ÿæˆè¡¨ç»“æ„

```go
  err = db.AutoMigrate(&Product{})
```

![ç”Ÿæˆè¡¨ç»“æ„](/public/images/orm-study/1-2.png)
![ç”Ÿæˆè¡¨ç»“æ„](/public/images/orm-study/1-3.png)

## gorm å®ç° CURD

#### æ–°å¢

```go
	db.Create(&Product{Code: "D42", Price: 100})
```

#### æŸ¥è¯¢

```go
	var product Product // æ³¨æ„ï¼šä¼ å…¥çš„æ˜¯æŒ‡é’ˆ
	db.First(&product, 1) // æ ¹æ®æ•´å‹ä¸»é”®æŸ¥æ‰¾
	db.First(&product, "code = ?", "D42") // æŸ¥æ‰¾ code å­—æ®µå€¼ä¸º D42 çš„è®°å½•

  fmt.Println(product.Code) // D42
```

#### æ–°å¢

```go
	var product Product // æ³¨æ„ï¼šéœ€è¦ä¸æŸ¥è¯¢è¯­å¥é…åˆä½¿ç”¨
	db.Model(&product).Update("Price", 200) // å°† product çš„ price æ›´æ–°ä¸º 200

  // Update - æ›´æ–°å¤šä¸ªå­—æ®µ
	db.Model(&product).Updates(Product{Price: 200, Code: "F42"}) // ä»…æ›´æ–°éé›¶å€¼å­—æ®µï¼Œéœ€è¦ä¼ é›¶å€¼å¾—è®¾ç½®æ¨¡å‹ç±»å‹
	db.Model(&product).Updates(map[string]interface{}{"Price": 200, "Code": "F42"})

```

#### åˆ é™¤ï¼ˆéç‰©ç†åˆ é™¤ï¼‰

```go
	db.Delete(&product, 1) // ä¼ å…¥ä¸»é”®å€¼

```
